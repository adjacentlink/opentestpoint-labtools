%define with_python2 %{?_with_python2:1}%{!?_with_python2:0}

Summary: OpenTestPoint labtools
Name: opentestpoint-labtools
Version: @VERSION@
Release: 1%{?dist}
License: BSD
Group: Development/Libraries
URL: https://github.com/adjacentlink/opentestpoint-labtools
Source0: %{name}-%{version}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
Vendor: Adjacent Link LLC
BuildArch: noarch

%define with_old_depends 0%{?el7}
%define with_pathfix 0%{!?el7}

%if 0%{?with_python2}
%if %{with_old_depends}
Requires: python
BuildRequires: python-devel
Requires: python-opentestpoint python-matplotlib numpy python-pandas python-zmq
%define use_python_sitelib %{python_sitelib}
%else
Requires: python2
BuildRequires: python2-devel
Requires: python2-opentestpoint python2-matplotlib python2-numpy python2-pandas python2-zmq
%define use_python_sitelib %{python2_sitelib}
%endif
%define use_python_version %{python2_version}
%define use_python_major_version 2
%else
Requires: python3
BuildRequires: python3-devel
Requires: python3-opentestpoint python3-matplotlib python3-numpy python3-pandas python3-zmq
%define use_python_sitelib %{python3_sitelib}
%define use_python_version %{python3_version}
%define use_python_major_version 3
%endif

%description
OpenTestPoint labtools

%prep
%setup -q

%build
%if 0%{?with_python2}
%configure --with-python2
%else
%configure
%endif
make

%install
make DESTDIR=${RPM_BUILD_ROOT} install

mv %{buildroot}/%{_bindir}/otestpoint-labtools-playback %{buildroot}/%{_bindir}/otestpoint-labtools-playback-%{use_python_version}
ln -s otestpoint-labtools-playback-%{use_python_version} %{buildroot}/%{_bindir}/otestpoint-labtools-playback-%{use_python_major_version}
ln -s otestpoint-labtools-playback-%{use_python_major_version} %{buildroot}/%{_bindir}/otestpoint-labtools-playback

%if 0%{?with_python2}
%if %{with_pathfix}
pathfix.py -pni "%{__python2} %{py2_shbang_opts}" %{buildroot}%{_bindir}/*-%{python2_version}
%endif
%else
pathfix.py -pni "%{__python3} %{py3_shbang_opts}" %{buildroot}%{_bindir}/*-%{python3_version}
%endif

%clean
rm -rf $RPM_BUILD_ROOT

%post
/sbin/ldconfig

%postun
/sbin/ldconfig

%files
%defattr(-,root,root,-)
%{use_python_sitelib}/*
%{_bindir}/otestpoint-labtools-playback
%{_bindir}/otestpoint-labtools-playback-%{use_python_version}
%{_bindir}/otestpoint-labtools-playback-%{use_python_major_version}

%doc AUTHORS
%doc COPYING
%doc NEWS
%doc README
%doc INSTALL
